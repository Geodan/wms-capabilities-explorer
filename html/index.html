<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="node_modules/openlayers/dist/ol.css" type="text/css">
    <script src="node_modules/openlayers/dist/ol.js"></script>
    <script src="node_modules/proj4/dist/proj4.js"></script>
<style>
    body {font-family: Arial, Helvetica, sans-serif;}
    #container {position: relative;}
    #generalcaps, #layers {max-width: 50%;}
    #map {position: absolute; top: 0; left: 50%; width: 50%; height: 100%; border: 1px solid gray;}
    .ol-control {border: 1px solid gray;}
</style>
<script>

    var currentCapabilities = {};
    var map=null;

    function clearMap() {
        if (map) {
            map.setTarget(null);
            map = null;        
        }
    }

    function getCapablitiesJson(url, callback){
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (callback) {
                    callback(null, xhr.responseText);
                }
            }
        }
        var formData = 'url=' + encodeURIComponent(url);
        xhr.open('POST', '/getcapabilities');
        xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=UTF-8');
        xhr.send(formData); 
    }

    function getLayerInfo(name) {
        var result = {};
        if (currentCapabilities) {
            if (name == currentCapabilities.Capability.Layer.Name) {
                result.Layer = currentCapabilities.Capability.Layer;
            } else {
                result.Layer = currentCapabilities.Capability.Layer.Layer.reduce(function(resultLayer, layer) {if (layer.Name==name) {return layer} else {return resultLayer};}, null);
            }
        }
        return result;
    }

    function loadProjection(projCode, callback) {
        var projection = ol.proj.get(projCode);
        if (projection) {
            callback(projection);
            return;
        }
        fetch('https://epsg.io/?format=json&q=' + projCode.split(':')[1]).then(function(response) {
            return response.json();
        }).then(function(json) {
            var results = json['results'];
            if (results && results.length > 0) {
                for (var i = 0, ii = results.length; i < ii; i++) {
                    var result = results[i];
                    if (result) {
                    var code = result['code'], name = result['name'],
                        proj4def = result['proj4'], bbox = result['bbox'];
                        if (code && code.length > 0 && proj4def && proj4def.length > 0 &&
                                bbox && bbox.length == 4) {
                            var newProjCode = 'EPSG:' + code;
                            proj4.defs(newProjCode, proj4def);
                            var newProj = ol.proj.get(newProjCode);
                            var fromLonLat = ol.proj.getTransform('EPSG:4326', newProj);

                            // very approximate calculation of projection extent
                            var extent = ol.extent.applyTransform([bbox[1], bbox[2], bbox[3], bbox[0]], fromLonLat);
                            newProj.setExtent(extent);
                            callback(newProj);
                            return;
                        }
                    }
                }
            }
            // no projection found, default to epsg:3857
            callback(ol.proj.get('EPSG:3857'));
        });
    }
    function getLayerExtent(layer, projCode) {
        var bbox = layer.BoundingBox.filter(box=>box.crs.toUpperCase()==projCode);
        if (bbox.length) {
            extent = bbox[0].extent;
            if (projCode.toUpperCase() == 'EPSG:4326' || projCode.toUpperCase() == 'CRS:84') {
                // convert lat/long to long/lat
                var tmp = extent;
                extent = [tmp[1], tmp[0], tmp[3], tmp[2]];
            }
            return extent;
        }
        // calculate projected extent based on lat long
        var fromLonLat = ol.proj.getTransform('EPSG:4326', projCode);
        var bbox = layer.BoundingBox.filter(box=>box.crs.toUpperCase()=='EPSG:4326');
        if (bbox.length) {
            extent = bbox[0].extent;
        } else {
            extent = [-90, -180, 90, 180];
        }
        extent = ol.extent.applyTransform([extent[1], extent[2], extent[3], extent[0]], fromLonLat);
        return extent;
    }
    function layerClick(name, projCode) {
        clearMap();
        layerInfo = getLayerInfo(name);
        loadProjection(projCode, function(projection){
            var getMapUrl = currentCapabilities.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource; 
            var serverType = 'qgis';
            if (name.indexOf(":") > -1) {
                serverType = 'geoserver';
            }
            if (getMapUrl.indexOf("map=") > -1) {
                if (getMapUrl.indexOf(".map") > -1) {
                    serverType = 'mapserver';
                } else if (getMapUrl.indexOf(".qgs") > -1) {
                    servertType = 'qgis';
                }
            }
            var extent = getLayerExtent(layerInfo.Layer, projCode);    
            var layers = [
                new ol.layer.Image({
                extent: extent,
                source: new ol.source.ImageWMS({
                    url: getMapUrl,
                    crossOrigin: 'anonymous',
                    attributions: 'Â© <a href="#">Not yet implemented</a>',
                    params: {
                    'LAYERS': name,
                    'FORMAT': 'image/png'
                    },
                    serverType: serverType
                })
                })
            ];

            map = new ol.Map({
                controls: ol.control.defaults().extend([
                new ol.control.ScaleLine()
                ]),
                layers: layers,
                target: 'map',
                view: new ol.View({
                projection: projection,
                center: [(extent[0]+extent[2])/2, (extent[1]+extent[3])/2], //ol.proj.fromLonLat([8.23, 46.86], projection),
                extent: extent//,
                //zoom: 7
                })
            });
            map.getView().fit(extent);
            map.addControl(new ol.control.ZoomSlider());
        });
    }
    // return <a href> links for every supported layer projection
    function layerClickHTML(layer) {
        return Array.from(new Set(layer.CRS)).map(crs=>'<a href="javascript:layerClick(\''+layer.Name+'\',\''+crs+'\')">' + crs + '</a>').join(" | ")
    }
    function outputCapabilities(caps)
    {
        var generalCapsDiv = document.getElementById('generalcaps');
        var layersDiv = document.getElementById('layers');
        generalCapsDiv.innerHTML = layersDiv.innerHTML = "";
        currentCapabilities = {};
        if (caps.error) {
            output.innerHTML = "<h2>Error</h2>" + caps.error;
            return;
        }
        if (caps.version == "") {
            output.innerHTML = "<h2>Failed</h2>Failed to retrieve capabilities";
            return;
        }
        var html = []
        html.push({"version": caps.version});
        html.push({"title": caps.Service.Title});
        html.push({"abstract": caps.Service.Abstract});
        html.push({"keywords": caps.Service.KeywordList.join(",")});
        html.push({"service url": caps.Service.OnlineResource});
        html.push({"contact": caps.Service.ContactInformation.ContactPersonPrimary.ContactPerson});
        html.push({"org": caps.Service.ContactInformation.ContactPersonPrimary.ContactOrganization});
        html.push({"fees": caps.Service.Fees});
        html.push({"access constraints": caps.Service.AccessConstraints});
        generalCapsDiv.innerHTML = "<table>" + html.map(obj=>"<tr><td><b>"+Object.keys(obj)[0]+"</b></td><td>" + obj[Object.keys(obj)[0]] + "</td></tr>").join('\n') + "</table>"
        
        layersDiv.innerHTML += 'Root: ' + caps.Capability.Layer.Name + ", title: " + caps.Capability.Layer.Title + ": " + layerClickHTML(caps.Capability.Layer)+ "<br>" +
          caps.Capability.Layer.Layer.map(layer=>' Sub: ' + layer.Name + ", title: " + layer.Title + ": " + layerClickHTML(layer)).join("<br>");
        currentCapabilities = caps;
    }
    function init()
    {
        var parseButton = document.getElementById('parsebutton');
        parseButton.addEventListener('click', function(target, event){
            clearMap();
            url = document.getElementById('inputurl').value;
            getCapablitiesJson(url, function(err, jsonstring){
                outputCapabilities(JSON.parse(jsonstring));
                console.log(jsonstring);
            })
        })
    }
</script>
</head>
<body onload="init()">
    <label for="inputurl">WMS baseurl</label><br>   
    <input id="inputurl" type="text" placeholder="http://server/wmsservice?param1=value1&param2=value2" size="100" value="http://localhost:8080/cgi-bin/qgis/qgis_mapserv.fcgi?map=cbsadministratief.qgs&service=WMS&request=getcapabilities&version=1.3.0"></input>
    <input id="parsebutton" type="button" value="parse">
    <select name="wmsversion">
        <option value="1.3.0">1.3.0</option>
        <option value="1.1.1">1.1.1</option>
        <option value="1.1.0">1.1.0</option>
        <option value="1.0.0">1.0.0</option>
    </select>
    <hr>
    <div id="container">
    <div id="generalcaps"></div>
    <div id="layers"></div>
    <div id="map" class="map"></div>
    </div>
</body>
</html>
