<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="node_modules/openlayers/dist/ol.css" type="text/css">
    <script src="node_modules/openlayers/dist/ol.js"></script>
    <script src="node_modules/proj4/dist/proj4.js"></script>
<style>
    body {font-family: Arial, Helvetica, sans-serif;}
    #container {position: relative;}
    #generalcaps, #layers {max-width: 50%;}
    #map {position: absolute; top: 0; left: 50%; width: 50%; height: 100%; border: 1px solid gray;}
    .ol-control {border: 1px solid gray;}
</style>
<script>

    var currentCapabilities = {};
    var map=null;

    function clearMap() {
        if (map) {
            map.setTarget(null);
            map = null;        
        }
    }

    function getCapablitiesJson(url, callback){
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (callback) {
                    callback(null, xhr.responseText);
                }
            }
        }
        var formData = 'url=' + encodeURIComponent(url);
        xhr.open('POST', '/getcapabilities');
        xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=UTF-8');
        xhr.send(formData); 
    }

    function getLayerInfo(name) {
        var result = {};
        if (currentCapabilities) {
            if (name == currentCapabilities.Capability.Layer.Name) {
                result.Layer = currentCapabilities.Capability.Layer;
            } else {
                result.Layer = currentCapabilities.Capability.Layer.Layer.reduce(function(resultLayer, layer) {if (layer.Name==name) {return layer} else {return resultLayer};}, null);
            }
        }
        return result;
    }
    function layerClick(name) {
        clearMap();
        layerInfo = getLayerInfo(name);
        var projCode = 'EPSG:3857';
        var projection = new ol.proj.Projection({
            code: projCode
        });
        var getMapUrl = currentCapabilities.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource; 
        var serverType = 'qgis';
        if (name.indexOf(":") > -1) {
            serverType = 'geoserver';
        }
        if (getMapUrl.indexOf("map=") > -1) {
            if (getMapUrl.indexOf(".map") > -1) {
                serverType = 'mapserver';
            } else if (getMapUrl.indexOf(".qgs") > -1) {
                servertType = 'qgis';
            }
        }
        var extent = layerInfo.Layer.BoundingBox.reduce(function(result, box){return box.crs.toUpperCase()==projCode?box.extent:result}, null)
        var layers = [
            new ol.layer.Image({
            extent: extent,
            source: new ol.source.ImageWMS({
                url: getMapUrl,
                crossOrigin: 'anonymous',
                attributions: 'Â© <a href="http://www.geo.admin.ch/internet/geoportal/' +
                    'en/home.html">Pixelmap 1:1000000 / geo.admin.ch</a>',
                params: {
                'LAYERS': name,
                'FORMAT': 'image/png'
                },
                serverType: serverType
            })
            })
        ];

        map = new ol.Map({
            controls: ol.control.defaults().extend([
            new ol.control.ScaleLine()
            ]),
            layers: layers,
            target: 'map',
            view: new ol.View({
            projection: projection,
            center: [(extent[0]+extent[2])/2, (extent[1]+extent[3])/2], //ol.proj.fromLonLat([8.23, 46.86], projection),
            extent: extent//,
            //zoom: 7
            })
        });
        map.getView().fit(extent);
        map.addControl(new ol.control.ZoomSlider());
    }
    function outputCapabilities(caps)
    {
        var generalCaps = document.getElementById('generalcaps');
        var layers = document.getElementById('layers');
        generalCaps.innerHTML = layers.innerHTML = "";
        currentCapabilities = {};
        if (caps.error) {
            output.innerHTML = "<h2>Error</h2>" + caps.error;
            return;
        }
        if (caps.version == "") {
            output.innerHTML = "<h2>Failed</h2>Failed to retrieve capabilities";
            return;
        }
        var html = []
        html.push({"version": caps.version});
        html.push({"title": caps.Service.Title});
        html.push({"abstract": caps.Service.Abstract});
        html.push({"keywords": caps.Service.KeywordList.join(",")});
        html.push({"service url": caps.Service.OnlineResource});
        html.push({"contact": caps.Service.ContactInformation.ContactPersonPrimary.ContactPerson});
        html.push({"org": caps.Service.ContactInformation.ContactPersonPrimary.ContactOrganization});
        html.push({"fees": caps.Service.Fees});
        html.push({"access constraints": caps.Service.AccessConstraints});
        generalCaps.innerHTML = "<table>" + html.map(obj=>"<tr><td><b>"+Object.keys(obj)[0]+"</b></td><td>" + obj[Object.keys(obj)[0]] + "</td></tr>").join('\n') + "</table>"
        html = [];
        html.push({"Root layer": caps.Capability.Layer.Name})
        generalCaps.innerHTML += 'Layers<br>Root: <a href="#" onclick="layerClick(\'' + caps.Capability.Layer.Name + '\');return false">' + caps.Capability.Layer.Name + "</a>, title: " + caps.Capability.Layer.Title + "<br>" +
          caps.Capability.Layer.Layer.map(layer=>' Sub: <a href="#" onclick="layerClick(\'' + layer.Name + '\');return false">' + layer.Name + "</a> title: " + layer.Title).join("<br>");
        currentCapabilities = caps;
    }
    function init()
    {
        var parseButton = document.getElementById('parsebutton');
        parseButton.addEventListener('click', function(target, event){
            clearMap();
            url = document.getElementById('inputurl').value;
            getCapablitiesJson(url, function(err, jsonstring){
                outputCapabilities(JSON.parse(jsonstring));
                console.log(jsonstring);
            })
        })
    }
</script>
</head>
<body onload="init()">
    <label for="inputurl">WMS baseurl</label><br>   
    <input id="inputurl" type="text" placeholder="http://server/wmsservice?param1=value1&param2=value2" size="100" value="http://localhost:8080/cgi-bin/qgis/qgis_mapserv.fcgi?map=cbsadministratief.qgs&service=WMS&request=getcapabilities&version=1.3.0"></input>
    <input id="parsebutton" type="button" value="parse">
    <select name="wmsversion">
        <option value="1.3.0">1.3.0</option>
        <option value="1.1.1">1.1.1</option>
        <option value="1.1.0">1.1.0</option>
        <option value="1.0.0">1.0.0</option>
    </select>
    <hr>
    <div id="container">
    <div id="generalcaps"></div>
    <div id="layers"></div>
    <div id="map" class="map"></div>
    </div>
</body>
</html>
